<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../app-data.html">
<link rel="import" href="../../../bower_components/app-localize-behavior/app-localize-behavior.html">

<dom-module id="page-connexion-visiteur">
  <template>
    <style include="shared-styles">

        .row {
            margin-left: 0px;
            margin-right: 0px;
        }
        
        .card-logo {
            margin-top: 60px;
        }
        
        .card-connexion-header  {
            text-align: center;
        }
        
        .btn-connexion {
            width: 100%;
            margin: 15px 0 0 0;
        }
        
        .large-icon {
            --iron-icon-height: 128px;
            --iron-icon-width: 128px;
        }
        
        .forgotten-password {
            text-align: center;
        }
        
        .logo-connexion {
            max-width: 100%;
        }
        
        .langue-btns {
            text-align: center;
            padding: 10px 0;
        }
        
        paper-radio-button {
            --paper-radio-button-checked-color: #000;
            --paper-radio-button-checked-ink-color: #000;
            --paper-radio-button-unchecked-ink-color: #000;
        }
        
    </style>
      
    <iron-meta id="meta"></iron-meta>
    <iron-meta key="langue" value="{{language}}"></iron-meta>
      
    <iron-localstorage name="data-storage" value="{{storedData}}"></iron-localstorage>
    <app-data key="storedData" data="{{storedData}}"></app-data>
      
    <iron-ajax 
    id="tokenRequest" 
    method="POST"
    body={{formData}}
    content-type="application/x-www-form-urlencoded"
    url="{{serverUrl}}/token/visiteur"
    on-response="_handleTokenResponse"
    on-error="_handleTokenError"></iron-ajax>

    <paper-toast id="toast" text="Identifiant ou mot de passe invalide"></paper-toast>
      
    <div class="row">
        <div class="col-sm-4 col-sm-offset-4">
            <div class="card card-logo">
                <img class="logo-connexion" src="[[nomDomaine]]/images/logo.png">
            </div>
            <div class="card card-connexion">
                <div class="card-connexion-header">
                    <h1>{{localize('page-connexion-visiteur')}}</h1>
                </div>
                <paper-input-container>
                    <label>{{localize('header67')}}</label>
                    <input is="iron-input" id="username" type="text" bind-value="{{formData.identifiant}}">
                </paper-input-container>

                <paper-input-container>
                    <label>{{localize('header68')}}</label>
                    <input is="iron-input" id="password" type="password" bind-value="{{formData.password}}">
                </paper-input-container>
                
                <div class="langue-btns">
                    <paper-radio-group selected="{{language}}">
                      <paper-radio-button name="fr">{{localize('header69')}}</paper-radio-button>
                      <paper-radio-button name="en">{{localize('header70')}}</paper-radio-button>
                    </paper-radio-group>
                </div>
                
                <div class="wrapper-btns">
                    <paper-button raised class="primary btn-connexion" on-tap="_postLogin" disabled$="{{_validateForm(formData.identifiant, formData.password)}}">{{localize('header71')}}</paper-button>
                </div>
            </div>
            <div class="forgotten-password">
                <paper-button noink class="primary btn-forgotten-password" on-tap="_openRecuperationIdentifiantsModal">{{localize('header72')}}</paper-button>
            </div>
        </div>
    </div>
  </template>

  <script>
    Polymer({
      is: 'page-connexion-visiteur',
      behaviors: [
        Polymer.AppLocalizeBehavior
      ],
      properties: {
        storedData: Object,
        formData: {
            type: Object,
            value: {
                identifiant: '',
                password: ''
            },
            notify: true
        },
        serverUrl: String,
        baseUrl: String,
        nomDomaine: String,
        language: {
            type: String,
            value: 'fr'
        }
      },
      ready: function () {
        this.serverUrl = this.$.meta.byKey("server-url");
        this.baseUrl = this.$.meta.byKey("base-url");
        this.nomDomaine = this.$.meta.byKey("nom-domaine");
      },
      attached: function() {
        this.loadResources(this.resolveUrl('../locales.json'));
      },
      _postLogin: function() {
        this.$.tokenRequest.generateRequest();
      },
      _validateForm: function(identifiant, password) {
          if(identifiant == '' || password == '') {
            return true;
          }
      },
      _handleTokenResponse: function(event) {
        var response = event.detail.response;
        if (response.token) {
            this.storedData = {
				token: response.token,
				loggedin: true,
                language: this.language
            };
            this.formData = {};
            window.location.href = this.baseUrl + '/visiteur/page-dossier/';
        } else {
            _handleTokenError();
        }
      },
      _handleTokenError: function(event) {
        this.formData = {
                identifiant: '',
                password: ''
        }
        this.$.toast.open();
      },
      _openRecuperationIdentifiantsModal: function(event) {
        this.fire('iron-signal', {name: 'open-recuperation-identifiants-modal', data: {language:this.language}});
      }
    });
  </script>
</dom-module>
