<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../app-data.html">
<link rel="import" href="../../bower_components/paper-countries/paper-countries.html">

<dom-module id="page-biodatas">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }
        
      .floating-text {
        color: #555555;
        font-size: 14px;
        font-weight: 500;
      }
        
      .see-next {
        position: absolute;
        bottom: 0px;
        right: 25px;
      }
        
      .see-previous {
        position: absolute;
        bottom: 0px;
        left: 25px;
      }
    
      .steps {
          text-align: center;
          color: #555555;
      }
        
      .step {
            display: inline-block;
            text-align: center;
            margin: 15px;
          width: 80px;
          position: relative;
      }
        .step:hover {
            cursor: pointer;
        }
        
        .step:hover .step-element::before  {
            transform: scale(1.4);
            transition: all 0.08s ease;

        }
        
        .step-selected > .step-element {
            opacity: 1 !important;
            transition: all 0.2s ease;
        }
        .step-element {
            margin-top: 10px;
            opacity: 0.3;
            color: #555555;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
      .step-element::before {
           content: "";
           display: block;
           background-color: #555555;
           border-radius: 25%;
	       width: 8px;
	       height: 8px;
           position: relative;
           margin: auto;
           margin-bottom: 10px;
           opacity: inherit;
          transform: scale(1);
          
            transition: all 0.08s ease;
      }
        
        .step:not(:first-child) .step-element::after {
           content: "";
           display: block;
           background-color: #555555;
	       width: 97px;
	       height: 2px;
           position: absolute;
           right: calc(50% + 9px);
           top: 3px;
           opacity: inherit;
      }
        
        .informations {
            text-align: center;
        }
        
        .informations iron-icon {
            --iron-icon-height: 128px;
            --iron-icon-width: 128px;
        }
        
        .text-center {
            text-align: center;
        }
        
        .toggle-button-vehicule {
            margin: 35px 0 35px 0;
        }
        
    </style>
    
    <iron-meta id="meta"></iron-meta>
    <iron-localstorage name="data-storage" value="{{storedData}}" on-iron-localstorage-load="_generateRequests"></iron-localstorage>
    <app-data key="storedData" data="{{storedData}}"></app-data>
      
    <iron-ajax 
    id="champsRequest"
    method="GET"
    headers="{{_computeHeaders(storedData)}}"
    url="{{serverUrl}}/profils/champs"
    handle-as="json"
    last-response="{{champs}}"
    on-response="_handleChampsResponse"
    on-error="_handleChampsError"></iron-ajax>
      
    <iron-ajax 
    id="biodatasRequest"
    method="POST"  
    headers="{{_computeHeaders(storedData)}}"
    url="{{serverUrl}}/biodatas"
    on-response="_handleBiodatasResponse"
    on-error="_handleBiodatasError"></iron-ajax>
    
    <div class="row">
        <div class="col-md-8">
            <div class="col-md-12">
                <div class="steps" >
                    <div class$="step {{_getClassesStep(currentStep, steps, 'accueil')}}" on-tap="_showStep" data-args="accueil">
                        <span on-tap="_showStep" data-args="accueil" class="step-element">Accueil</span>
                    </div>
                    <div class$="step {{_getClassesStep(currentStep, steps, 'identite')}}" on-tap="_showStep" data-args="identite">
                        <span on-tap="_showStep" data-args="identite" class="step-element">Identité</span>
                    </div>
                    <div class$="step {{_getClassesStep(currentStep, steps, 'fichiers')}}" on-tap="_showStep" data-args="fichiers">
                        <span on-tap="_showStep" data-args="fichiers" class="step-element">Documents</span>
                    </div>
                    <div class$="step {{_getClassesStep(currentStep, steps, 'vehicule')}}" on-tap="_showStep" data-args="vehicule">
                        <span on-tap="_showStep" data-args="vehicule" class="step-element">Véhicule</span>
                    </div>
                    <div class$="step {{_getClassesStep(currentStep, steps, 'envoi')}}" on-tap="_showStep" data-args="envoi">
                        <span on-tap="_showStep" data-args="envoi" class="step-element">Envoi</span>
                    </div>
                </div>
            </div>
            <div class="col-lg-12" hidden$="{{_hideStep('accueil', currentStep)}}">
                <div class="card">
                    <div class="row">
                        <div class="col-md-12">
                            <p>Informations</p>
                            <div class="informations">
                                <p>SeaTestBase est situé dans une zone à accés réglementé. Obtenir des autorisations est nécessaire pour y accéder.</p>
                                <iron-icon large-icon icon="image:portrait"></iron-icon>
                                <div>
                                    <paper-button on-tap="_showStep" data-args="identite">Commencer</paper-button>
                                </div>
                            </div>
                            <p></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-12" hidden$="{{_hideStep('identite', currentStep)}}">
                <div class="card">
                    <div class="row">
                        <div class="col-md-12">
                            <p>Identité</p>
                        </div>
                        <div class="col-md-8 col-md-offset-2">
                            <template is="dom-repeat" items="{{champs}}">
                                <template is="dom-if" if="{{_computeHidden(item, 'texte_nomprenom')}}">
                                    <div class="row nomprenom">
                                        <div class="col-md-6">
                                            <paper-input-container>
                                                <label>Nom</label>
                                                <input is="iron-input" id="nom" type="text" bind-value="{{item.saisie.nom}}">
                                            </paper-input-container>
                                        </div>
                                        <div class="col-md-6">
                                            <paper-input-container>
                                                <label>Prénom</label>
                                                <input is="iron-input" id="prenom" type="text" bind-value="{{item.saisie.test}}">
                                            </paper-input-container>
                                        </div>
                                    </div>
                                </template>
                                <template is="dom-if" if="{{_computeHidden(item, 'texte_date')}}">
                                    <div class="row datenaissance">
                                        <div class="col-md-12">
                                            <vaadin-date-picker value="{{item.saisie.aa}}" label="Date de naissance"></vaadin-date-picker>
                                        </div>
                                    </div>
                                </template>

                                <!-- ADRESSE -->

                                <template is="dom-if" if="{{_computeHidden(item, 'texte_adresse')}}">
                                    <div class="row adresse">
                                        <div class="col-md-12">
                                            <p>[[item.nom]]</p>
                                        </div>
                                        <div class="col-md-3"> 
                                            <paper-input-container>
                                                <label>Numéro</label>
                                                <input is="iron-input" id="username" type="number" bind-value="{{item.saisie.numero}}">
                                            </paper-input-container>
                                        </div>
                                        <div class="col-md-6">
                                            <paper-input-container>
                                                <label>Rue</label>
                                                <input is="iron-input" id="username" type="text" bind-value="{{item.saisie.rue}}">
                                            </paper-input-container>
                                        </div>
                                        <div class="col-md-3">
                                            <gold-zip-input label="Code postal" value="{{item.saisie.codepostal}} "></gold-zip-input>
                                        </div>
                                        <div class="col-md-5">
                                            <paper-input-container>
                                                <label>Ville</label>
                                                <input is="iron-input" id="username" type="text" bind-value="{{item.saisie.ville}}">
                                            </paper-input-container>
                                        </div>
                                        <div class="col-md-7">
                                            <paper-countries country="[[country]]" value="{{item.saisie.pays}}" max-suggestions="3" auto-validate="true" label="Pays" placeholder="Saisir le pays"></paper-countries>
                                        </div>
                                    </div>
                                </template>

                                <!-- NUMERO DE TELEPHONE -->

                                <template is="dom-if" if="{{_computeHidden(item, 'texte_telephone')}}">
                                    <div class="row telephone">
                                        <div class="col-md-12">
                                            <paper-input-container>
                                                <label>[[item.nom]]</label>
                                                <input is="iron-input" id="telephone" bind-value="{{item.saisie.telephone}}"></input>
                                            </paper-input-container>
                                        </div>
                                    </div>
                                </template>

                                <!-- TEXTE LIBRE TEXTAREAS -->
                                <template is="dom-if" if="{{_computeHidden(item, 'texte_textarea')}}">
                                    <div class="row texte">
                                        <div class="col-md-12">
                                            <paper-input-container>
                                                <label>[[item.nom]]</label>
                                                <iron-autogrow-textarea class="paper-input-input" bind-value="{{item.saisie.remarques}}"></iron-autogrow-textarea>
                                            </paper-input-container>
                                        </div>
                                    </div>
                                </template>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-12" hidden$="{{_hideStep('fichiers', currentStep)}}">
                    <div class="card">
                    <div class="row">
                        <div class="col-md-12">
                            <p>Documents d'identité à joindre à votre demande</p>
                        </div>
                        <div class="col-md-8 col-md-offset-2">
                            <p>Merci d'indiquer votre nationalité. Les documents d'identité demandés depéndent de votre nationalité.</p>
                            <paper-autocomplete label="Nationalité" source="{{nationalites}}" value="{{selectedNationalite}}"></paper-autocomplete>
                        </div>
                        <template is="dom-repeat" items="{{champs}}">
                            <template is="dom-if" if="{{_computeHidden(item, 'identite_fichier')}}">
                                <template is="dom-if" if="{{_isNationality(item, selectedNationalite)}}">
                                    <div class="col-md-8 col-md-offset-2">
                                        <label>{{item.nom}}</label>
                                        <input id="fichier[[item.identifiant]]" type="file" on-change="_previewFile">
                                    </div>
                                </template>
                            </template>
                        </template>   
                    </div>                
                </div>
            </div>
            <div class="col-lg-12" hidden$="{{_hideStep('vehicule', currentStep)}}">
                <div class="card">
                    <div class="row">
                        <div class="col-md-12">
                            <p>Véhicule</p>
                        </div>
                        <div class="col-md-8 col-md-offset-2 text-center">
                                <p>Afin d'accéder au site avec votre véhicule, des informations complémentaires sont nécessaires.
                                Passez cette étape si vous n'êtes pas le conducteur d'un véhicule.</p>
                                <paper-toggle-button class="toggle-button-vehicule" checked="{{vehicule}}">Je serais le conducteur d'un véhicule</paper-toggle-button>
                        </div> 
                        <div class="col-md-8 col-md-offset-2">
                            <template is="dom-if" if="{{vehicule}}">
                                    <template is="dom-repeat" items="{{champs}}">
                                        <template is="dom-if" if="{{_computeHidden(item, 'vehicule_fichier')}}">
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <label>{{item.nom}}</label>
                                                    <input id="fichier[[item.identifiant]]" type="file" on-change="_previewFile">
                                                </div>
                                            </div>
                                        </template>
                                        <template is="dom-if" if="{{_computeHidden(item, 'vehicule_texte')}}">
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <paper-input-container>
                                                        <label>{{item.nom}}</label>
                                                        <input is="iron-input" id="username" type="text" bind-value="{{item.saisie.immatriculation}}">
                                                    </paper-input-container>
                                                </div>
                                            </div>
                                        </template>
                                    </template>                   
                            </template>
                        </div>
                    </div>
                </div>  
            </div>
            <div class="col-lg-12" hidden$="{{_hideStep('envoi', currentStep)}}">
                <div class="card">
                    <div class="row">
                        <div class="col-md-8 col-md-offset-2">
                            <p>Envoi</p>
                            <paper-checkbox>Je confirme la validité des données saisies</paper-checkbox>
                            <paper-checkbox>J'accepte la transmission des données aux autorités françaises</paper-checkbox>
                            <paper-button on-tap="_sendBiodatas">Envoyer</paper-button>
                        </div>
                    </div>
                </div>  
            </div>
            <paper-fab class="see-next" icon=":icons:chevron-right" on-tap="_showNext"></paper-fab>
            <paper-fab class="see-previous" icon=":icons:chevron-left" on-tap="_showPrevious"></paper-fab>
        </div>
        <div class="col-md-4">
             <div class="col-md-12">
                <p class="floating-text">Informations</p>
                <p>Pour un traitement rapide de votre dossier, penser à contrôler l'exactitude des informations saisies.</p>
            </div>
        </div>
      </div>
  </template>

  <script>
    Polymer({
      is: 'page-biodatas',
      properties: {
        champs: Object,
        serverUrl: String,
        nationalites: Object,
        selectedNationalite: String,
        fichiers: {
            type: Object,
            value: []
        },
        currentStep: {
            type: String,
            value: "accueil"
        },
        steps: {
            type: Object,
            value: [
               "accueil",
               "identite",
               "fichiers",
               "vehicule",
               "envoi"
                ]
        }
      },
      ready: function () {
          
        this.nationalites = [
   "Afghan",
   "Albanian",
   "Algerian",
   "American",
   "Andorran",
   "Angolan",
   "Antiguans",
   "Argentinean",
   "Armenian",
   "Australian",
   "Austrian",
   "Azerbaijani",
   "Bahamian",
   "Bahraini",
   "Bangladeshi",
   "Barbadian",
   "Barbudans",
   "Batswana",
   "Belarusian",
   "Belge",
   "Belizean",
   "Beninese",
   "Bhutanese",
   "Bolivian",
   "Bosnian",
   "Brazilian",
   "British",
   "Bruneian",
   "Bulgarian",
   "Burkinabe",
   "Burmese",
   "Burundian",
   "Cambodian",
   "Cameroonian",
   "Canadienne",
   "Cape Verdean",
   "Central African",
   "Chadian",
   "Chilean",
   "Chinese",
   "Colombian",
   "Comoran",
   "Congolese",
   "Costa Rican",
   "Croatian",
   "Cuban",
   "Cypriot",
   "Czech",
   "Danish",
   "Djibouti",
   "Dominican",
   "Dutch",
   "East Timorese",
   "Ecuadorean",
   "Egyptian",
   "Emirian",
   "Equatorial Guinean",
   "Eritrean",
   "Estonian",
   "Ethiopian",
   "Fijian",
   "Filipino",
   "Finnish",
   "Française",
   "Gabonese",
   "Gambian",
   "Georgian",
   "German",
   "Ghanaian",
   "Greek",
   "Grenadian",
   "Guatemalan",
   "Guinea-Bissauan",
   "Guinean",
   "Guyanese",
   "Haitian",
   "Herzegovinian",
   "Honduran",
   "Hungarian",
   "I-Kiribati",
   "Icelander",
   "Indian",
   "Indonesian",
   "Iranian",
   "Iraqi",
   "Irish",
   "Israeli",
   "Italian",
   "Ivorian",
   "Jamaican",
   "Japanese",
   "Jordanian",
   "Kazakhstani",
   "Kenyan",
   "Kittian and Nevisian",
   "Kuwaiti",
   "Kyrgyz",
   "Laotian",
   "Latvian",
   "Lebanese",
   "Liberian",
   "Libyan",
   "Liechtensteiner",
   "Lithuanian",
   "luxembourgeoise",
   "Macedonian",
   "Malagasy",
   "Malawian",
   "Malaysian",
   "Maldivan",
   "Malian",
   "Maltese",
   "Marshallese",
   "Mauritanian",
   "Mauritian",
   "Mexican",
   "Micronesian",
   "Moldovan",
   "Monégasque",
   "Mongolian",
   "Moroccan",
   "Mosotho",
   "Motswana",
   "Mozambican",
   "Namibian",
   "Nauruan",
   "Nepalese",
   "New Zealander",
   "Nicaraguan",
   "Nigerian",
   "Nigerien",
   "North Korean",
   "Northern Irish",
   "Norwegian",
   "Omani",
   "Pakistani",
   "Palauan",
   "Panamanian",
   "Papua New Guinean",
   "Paraguayan",
   "Peruvian",
   "Polish",
   "Portuguese",
   "Qatari",
   "Romanian",
   "Russian",
   "Rwandan",
   "Saint Lucian",
   "Salvadoran",
   "Samoan",
   "San Marinese",
   "Sao Tomean",
   "Saudi",
   "Scottish",
   "Senegalese",
   "Serbian",
   "Seychellois",
   "Sierra Leonean",
   "Singaporean",
   "Slovakian",
   "Slovenian",
   "Solomon Islander",
   "Somali",
   "South African",
   "South Korean",
   "Spanish",
   "Sri Lankan",
   "Sudanese",
   "Surinamer",
   "Swazi",
   "Swedish",
   "Suisse",
   "Syrian",
   "Taiwanese",
   "Tajik",
   "Tanzanian",
   "Thai",
   "Togolese",
   "Tongan",
   "Trinidadian or Tobagonian",
   "Tunisian",
   "Turkish",
   "Tuvaluan",
   "Ugandan",
   "Ukrainian",
   "Uruguayan",
   "Uzbekistani",
   "Venezuelan",
   "Vietnamese",
   "Welsh",
   "Yemenite",
   "Zambian",
   "Zimbabwean"
];
          
        this.serverUrl = this.$.meta.byKey("server-url");
      },
      attributeChanged : function(name, type){
          if(this.getAttribute('class').includes('iron-selected')){
            this._generateRequests();
          }
      },
      _computeHeaders: function(storedData) {
        return {"Authorization": "JWT " + storedData.token };
      },
      _generateRequests: function() {
          this.$.champsRequest.params = { profil: '1' };
          this.$.champsRequest.generateRequest();
      },
      _handleChampsResponse: function(res) {
          console.log(this.champs);
          for (var i = 0; i < this.champs.length; i++) {
            this.champs[i].saisie = { };
          }
      },
      _showNext: function(event) {
          if(this.steps[this.steps.indexOf(this.currentStep) + 1]) {
            this.currentStep = this.steps[this.steps.indexOf(this.currentStep) + 1];
          }
      },
      _showPrevious: function(event) {
          if(this.steps[this.steps.indexOf(this.currentStep) - 1]) {
            this.currentStep = this.steps[this.steps.indexOf(this.currentStep) - 1];
          }
      },
      _showStep: function(event) {
          if(this.steps[this.steps.indexOf(event.target.getAttribute('data-args'))]) {
              this.currentStep = event.target.getAttribute('data-args');
          }
      },
      _hideStep: function(step, currentStep) {
        if(step == currentStep) {
            return false;
        } else {
            return true;
        }
      },
      _getClassesStep: function(currentStep, steps, step) {
        if(steps.indexOf(currentStep) >= steps.indexOf(step)) {
            return 'step-selected';
        } else {
            return 'step-unselected';
        }
      },
      _computeHidden: function(item, type) {
          return (item.type == type && item.coche == true);
      },
      _isNationality: function(item, selectedNationalite) {
            if(selectedNationalite.toLowerCase() == 'française' || selectedNationalite.toLowerCase() == 'francaise'
               || selectedNationalite.toLowerCase() == 'français' || selectedNationalite.toLowerCase() == 'francais') {
                if(item.nom == "Carte d'identité" || item.nom == "Passeport") {
                    return true;
                } else {
                    return false;
                }
            } else {         
                if(item.nom == "Carte de séjour" || item.nom == "Passeport") {
                    return true;
                } else {
                    return false;
                }   
            }
      },
      _previewFile: function(event) {
          var item = event.model.get('item');
          var fichier = Polymer.dom(this.root).querySelector('#fichier'+item.identifiant).files[0];
          
          if (this.fichiers.find(fichier => fichier.identifiantChamp === item.identifiant)) {
              console.log(this.fichiers.find(fichier => fichier.identifiantChamp === item.identifiant));
              
              for(var i=0 ; i < this.fichiers.length; i++) {
                    if(this.fichiers[i].identifiantChamp == item.identifiant) {
                        this.fichiers.splice(i, 1); 
                    }
              }
          }
          
          this.fichiers.push({ identifiantChamp: item.identifiant, fichier: fichier});
          console.log(this.fichiers);
      },
      _sendBiodatas: function() {
          var formData = new FormData();
          formData.append("image", this.fichiers[0].fichier);
          formData.append("test", "ok");
          formData.append("champs", this.champs);
          this.$.biodatasRequest.body = formData;
          this.$.biodatasRequest.generateRequest();
      },
      _handleBiodatasResponse: function(response) {
          console.log('ok');
      }
    });
  </script>
</dom-module>
