<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-countries/paper-countries.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../app-data.html">
<link rel="import" href="./components/conseils-biodatas.html">
<link rel="import" href="./components/informations-champ.html">
<link rel="import" href="./components/etapes-biodatas.html">
<link rel="import" href="./components/accueil-biodatas.html">
<link rel="import" href="./components/confirmation-biodatas.html">
<link rel="import" href="./components/date-format-visiteur.html">
<link rel="import" href="./components/liste-nationalites.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">

<script src="../../bower_components/moment/moment.js"></script>
<script src="../../bower_components/moment/locale/fr.js"></script>

<dom-module id="page-biodatas">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }
        
      paper-fab {
        --paper-fab-background: #5bb47d;
      }
        
      paper-checkbox {
        --paper-checkbox-checked-color: #5bb47d;
        --paper-checkbox-checked-ink-color: #5bb47d;
        --paper-checkbox-unchecked-color: #008975;
        --paper-checkbox-unchecked-ink-color: #5bb47d;
      }
        
      paper-toggle-button {
        --paper-toggle-button-checked-bar-color:  #00aa8d;
        --paper-toggle-button-checked-button-color:  #008975;
        --paper-toggle-button-checked-ink-color: #00aa8d;
      }
        
      .floating-text {
        color: #555555;
        font-size: 14px;
        font-weight: 500;
      }
        
      .see-next {
        position: absolute;
        bottom: 0px;
        right: 25px;
      }
        
      .see-previous {
        position: absolute;
        bottom: 0px;
        left: 25px;
      }
        
        .text-center {
            text-align: center;
        }
        
        .margin-top-bottom {
            margin: 30px 0 30px 0;
        }
        
        .margin-bottom {
            margin: 0 0 20px 0;
        }
        
        .toggle-button-vehicule {
            margin: 35px 0 35px 0;
        }
        
        .row-champ {
            position: relative;
        }
        
        .adresse {
            margin-top: 25px;
            margin-bottom: 25px;
        }
        
        .titre-adresse {
            margin-bottom: -25px;
        }
        
        .passeport img, .carte-identite img, .permis img, .immatriculation img {
            width: 80%;
        }
        
        .big-iron-icon {
            --iron-icon-height: 48px;
            --iron-icon-width: 48px;
        }
        
        .file-upload-zone {
            border: 1px dashed;
            border-color: #dbdbdb;
            border-radius: 3px;
            overflow: hidden;
            padding: 25px;
            margin-top: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .file-upload-zone > label {
            margin-left: 15px;
        }
        
        .file-upload {
            width: 100%;
            height: 100%;
            opacity: 0;
            left: 0;
            top: 0;
            position: absolute;
            z-index: 10;
            cursor: pointer;
        }
        
        .file-upload-button {
            cursor: pointer;
            border: 1px solid #dbdbdb;
            padding: 10px;
            border-radius: 3px;
        }
        
        .file-details {
            font-size: 0.8em;
        }
        
        .row-champ-fichier:not(:last-of-type) .file-upload-zone:after {
            content: 'Ou';
            text-transform: uppercase;
            background: #eee;
            padding: 8px;
            border-radius: 3px;
            position: absolute;
            left: -3px;
            bottom: -20px;
            z-index: 15;
        }
        
        @media screen and (max-width: 640px) {
            .card {
                margin-left: 0;
                margin-right: 0;
                padding-bottom: 35px;
                margin-bottom: 60px;
            }
            
            .see-previous, .see-next {
                bottom: -28px;
            }
        }
    </style>
    
    <iron-meta id="meta"></iron-meta>
    <iron-localstorage name="data-storage" value="{{storedData}}" on-iron-localstorage-load="_generateRequests"></iron-localstorage>
    <app-data key="storedData" data="{{storedData}}"></app-data>
    
    <iron-ajax 
        id="champsRequest"
        method="GET"
        headers="{{_computeHeaders(storedData)}}"
        url="{{serverUrl}}/visiteurs/profils/champs"
        handle-as="json"
        last-response="{{champs}}"
        on-response="_handleChampsResponse"
        on-error="_handleHttpError"></iron-ajax>
      
    <iron-ajax 
        id="historiqueEnvoyeRequest" 
        method="GET"
        headers="{{_computeHeaders(storedData)}}"
        url="{{serverUrl}}/visiteurs/biodatas"
        handle-as="json"
        last-response="{{biodatasEnvoyees}}"
        on-error="_handleHttpError"></iron-ajax>
    
    <iron-ajax 
        id="dateLimiteRequest"
        method="GET"
        headers="{{_computeHeaders(storedData)}}"
        url="{{serverUrl}}/visiteurs/projets/datelimite"
        handle-as="json"
        last-response="{{dateLimite}}"
        on-error="_handleHttpError"></iron-ajax>
      
    <iron-ajax 
        id="biodatasRequest"
        method="POST"
        headers="{{_computeHeaders(storedData)}}"
        url="{{serverUrl}}/visiteurs/biodatas"
        on-response="_handleBiodatasResponse"
        on-error="_handleBiodatasError"></iron-ajax>
    
    <template is="dom-if" if="{{_afficherFormulaire(biodatasOk, biodatasEnvoyees, dateLimite)}}">
            <div class="col-md-8">
                <div class="col-md-12">
                    <etapes-biodatas steps={{steps}} current={{currentStep}} erreurs="[[erreurs]]" language={{storedData.language}}></etapes-biodatas>
                </div>
                <div class="col-lg-12" hidden$="{{_hideStep('accueil', currentStep)}}">
                    <div class="card">
                        <accueil-biodatas language="{{storedData.language}}"></accueil-biodatas>
                    </div>
                </div>
                <div class="col-lg-12" hidden$="{{_hideStep('identite', currentStep)}}">
                    <div class="card">
                        <div class="row">
                            <div class="col-md-8 col-md-offset-2">
                                <div class="margin-top-bottom">
                                    <template is="dom-repeat" items="{{champs}}">
                                        <template is="dom-if" if="{{_computeHidden(item, 'texte_nomprenom')}}">
                                            <div class="row row-champ nomprenom">
                                                <div class="col-md-6">
                                                    <paper-input-container>
                                                        <label>{{localize('page-biodatas')}}</label>
                                                        <input is="iron-input" id="nom" type="text" bind-value="{{item.saisie.nom}}">
                                                    </paper-input-container>
                                                </div>
                                                <div class="col-md-6">
                                                    <paper-input-container>
                                                        <label>{{localize('header53')}}</label>
                                                        <input is="iron-input" id="prenom" type="text" bind-value="{{item.saisie.prenom}}">
                                                    </paper-input-container>
                                                </div>
                                                <informations-champ obligatoire="[[item.obligatoire]]" nom="[[item.nom]]" erreurs="[[erreurs]]" language="{{storedData.language}}"></informations-champ>
                                            </div>
                                        </template>
                                        <template is="dom-if" if="{{_computeHidden(item, 'texte_date')}}">
                                            <div class="row row-champ datenaissance" on-mouseover="_itemHovered" on-mouseout="_aucunItem">
                                                <div class="col-md-12">
                                                    <date-format-visiteur date-format="{{dateFormat}}" language="{{storedData.language}}"></date-format-visiteur>
                                                    <vaadin-date-picker i18n="{{dateFormat}}" min="1900-01-01" max="{{dateMax}}" value="{{item.saisie.date}}" label="Date de naissance"></vaadin-date-picker>
                                                </div>
                                                <informations-champ obligatoire="[[item.obligatoire]]" nom="[[item.nom]]" erreurs="[[erreurs]]" language="{{storedData.language}}"></informations-champ>
                                            </div>
                                        </template>

                                        <!-- ADRESSE -->

                                        <template is="dom-if" if="{{_computeHidden(item, 'texte_adresse')}}">
                                            <div class="row row-champ adresse" on-mouseover="_itemHovered" on-mouseout="_aucunItem">
                                                <div class="col-md-12 titre-adresse">
                                                    <p>[[item.nom]]</p>
                                                </div>
                                                <div class="col-md-3"> 
                                                    <paper-input-container>
                                                        <label>{{localize('header54')}}</label>
                                                        <input is="iron-input" id="username" type="number" bind-value="{{item.saisie.numero}}">
                                                    </paper-input-container>
                                                </div>
                                                <div class="col-md-6">
                                                    <paper-input-container>
                                                        <label>{{localize('header55')}}</label>
                                                        <input is="iron-input" id="username" type="text" bind-value="{{item.saisie.rue}}">
                                                    </paper-input-container>
                                                </div>
                                                <div class="col-md-3">
                                                    <paper-input-container>
                                                        <label>{{localize('header56')}}</label>
                                                        <input is="iron-input" id="codepostal" type="number" bind-value="{{item.saisie.codePostal}}">
                                                    </paper-input-container>
                                                </div>
                                                <!--*****************-->
                                                <div class="col-md-12">
                                                    <paper-input-container>
                                                        <label>{{localize('header57')}}</label>
                                                        <input is="iron-input" id="username" type="text" bind-value="{{item.saisie.autreReponse}}">
                                                    </paper-input-container>
                                                </div>
                                                <!--*****************-->
                                                <div class="col-md-5">
                                                    <paper-input-container>
                                                        <label>{{localize('header58')}}</label>
                                                        <input is="iron-input" id="username" type="text" bind-value="{{item.saisie.ville}}">
                                                    </paper-input-container>
                                                </div>
                                                <div class="col-md-7">
                                                    <paper-countries country="[[country]]" value="{{item.saisie.pays}}" max-suggestions="3" auto-validate="true" label="Pays" placeholder="Saisir le pays"></paper-countries>
                                                </div>
                                                <informations-champ obligatoire="[[item.obligatoire]]" nom="[[item.nom]]" erreurs="[[erreurs]]" language="{{storedData.language}}"></informations-champ>
                                            </div>
                                        </template>

                                        <!-- NUMERO DE TELEPHONE -->

                                        <template is="dom-if" if="{{_computeHidden(item, 'texte_telephone')}}">
                                            <div class="row row-champ telephone" on-mouseover="_itemHovered" on-mouseout="_aucunItem">
                                                <div class="col-md-12">
                                                    <paper-input-container>
                                                        <label>[[item.nom]]</label>
                                                        <input is="iron-input" id="telephone" bind-value="{{item.saisie.telephone}}"></input>
                                                    </paper-input-container>
                                                </div>
                                                <informations-champ obligatoire="[[item.obligatoire]]" nom="[[item.nom]]" erreurs="[[erreurs]]" language="{{storedData.language}}"></informations-champ>
                                            </div>
                                        </template>

                                        <!-- TEXTE LIBRE TEXTAREAS -->
                                        <template is="dom-if" if="{{_computeHidden(item, 'texte_textarea')}}">
                                            <div class="row row-champ texte" on-mouseover="_itemHovered" on-mouseout="_aucunItem">
                                                <div class="col-md-12">
                                                    <paper-input-container>
                                                        <label>[[item.nom]]</label>
                                                        <iron-autogrow-textarea class="paper-input-input" bind-value="{{item.saisie.remarques}}"></iron-autogrow-textarea>
                                                    </paper-input-container>
                                                </div>
                                                <informations-champ obligatoire="[[item.obligatoire]]" nom="{{item.nom}}" erreurs="{{erreurs}}" language="{{storedData.language}}"></informations-champ>
                                            </div>
                                        </template>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-12" hidden$="{{_hideStep('fichiers', currentStep)}}">
                    <div class="card">
                        <div class="row">
                            <div class="col-md-8 col-md-offset-2">
                                <!-- AFFICHAGE DU CHOIX DE LA NATIONALITE SI ELLE EST ACTIVEE POUR CE PROFIL -->
                                <template is="dom-repeat" items="{{champs}}">
                                    <template is="dom-if" if="{{_computeHidden(item, 'identite_nationalite')}}">
                                        <div class="row row-champ">
                                            <div class="col-md-12">
                                                <div class="text-center">
                                                    <p>{{localize('header59')}}</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row row-champ">
                                            <div class="col-md-12">
                                                <liste-nationalites nationalites="{{nationalites}}"></liste-nationalites>
                                                <paper-autocomplete label="Nationalité" source="{{nationalites}}" value="{{item.saisie.nationalite}}" on-value-changed="_saisieNationalite"></paper-autocomplete>
<!--                                                <informations-champ obligatoire="true" nom="" erreurs="[[erreurs]]" language="{{storedData.language}}"></informations-champ>-->
                                                <informations-champ obligatoire="[[item.obligatoire]]" nom="[[item.nom]]" erreurs="[[erreurs]]" language="{{storedData.language}}"></informations-champ>
                                            </div>
                                        </div>
                                    </template>
                                </template>
                                
                                <!-- AFFICHAGE DES CHAMPS POUR LES FICHIERS -->
                                <!-- SI LA NATIONALITE EST ACTIVEE, LES CHAMPS CORRESPONDANT A LA NATIONALITE S'AFFICHENT -->
                                <!-- SINON, ILS S'AFFICHENT TOUS -->
                                
                                <template is="dom-repeat" items="{{champs}}">
                                    <template is="dom-if" if="{{_computeHidden(item, 'identite_fichier')}}">
                                       <template is="dom-if" if="{{_isNationality(item, saisieNationalite)}}">
                                            <div class="row row-champ row-champ-fichier">
                                                <div class="col-md-12" on-mouseover="_itemHovered" on-mouseout="_aucunItem">
                                                    <div class="file-upload-zone file-upload-zone-identite">
                                                        <span class="file-upload-button"><iron-icon icon="icons:file-upload"></iron-icon>{{localize('header60')}}</span>
                                                        <label for="fichier[[item.identifiant]]">{{item.nom}}</label>
                                                        <div>
                                                            <span class="file-details">{{_getFileName(item, fichiers)}}</span>
                                                        </div>
                                                        <input class="file-upload" id="fichier[[item.identifiant]]" type="file" on-change="_addFile">
                                                    </div>
                                                </div>
                                                <informations-champ obligatoire="[[item.obligatoire]]" nom="[[item.nom]]" erreurs="[[erreurs]]" language="{{storedData.language}}"></informations-champ>
                                            </div>
                                      </template>
                                    </template>
                                </template>   
                            </div>
                        </div>
                    </div> 
                </div>
                <div class="col-lg-12" hidden$="{{_hideStep('vehicule', currentStep)}}">
                    <div class="card">
                        <div class="row">
                            <div class="col-md-8 col-md-offset-2 text-center">
                                <p>{{localize('header61')}}</p>
                                <paper-toggle-button class="toggle-button-vehicule" checked="{{vehicule}}">{{localize('header62')}}</paper-toggle-button>
                            </div> 
                            <div class="col-md-8 col-md-offset-2">
                                <template is="dom-if" if="{{vehicule}}">
                                        <template is="dom-repeat" items="{{champs}}">
                                            <template is="dom-if" if="{{_computeHidden(item, 'vehicule_fichier')}}">
                                                <div class="row row-champ">
                                                    <div class="col-md-12" on-mouseover="_itemHovered" on-mouseout="_aucunItem">
                                                        <div class="file-upload-zone">
                                                            <span class="file-upload-button"><iron-icon icon="icons:file-upload"></iron-icon>{{localize('header63')}}</span>
                                                            <label for="fichier[[item.identifiant]]">{{item.nom}}</label>
                                                            <input class="file-upload" id="fichier[[item.identifiant]]" type="file" on-change="_addFile">
                                                        </div>
                                                    </div>
                                                    <informations-champ obligatoire="[[item.obligatoire]]" nom="[[item.nom]]" erreurs="[[erreurs]]" language="{{storedData.language}}"></informations-champ>
                                                </div>
                                            </template>
                                            <template is="dom-if" if="{{_computeHidden(item, 'vehicule_texte')}}">
                                                <div class="row row-champ">
                                                    <div class="col-md-12" on-mouseover="_itemHovered" on-mouseout="_aucunItem">
                                                        <paper-input-container>
                                                            <label >{{item.nom}}</label>
                                                            <input is="iron-input" id="username" type="text" bind-value="{{item.saisie.immatriculation}}">
                                                        </paper-input-container>
                                                    </div>
                                                    <informations-champ obligatoire="[[item.obligatoire]]" nom="[[item.nom]]" erreurs="[[erreurs]]" language="{{storedData.language}}"></informations-champ>
                                                </div>
                                            </template>
                                        </template>                   
                                </template>
                            </div>
                        </div>
                    </div>  
                </div>
                <div class="col-lg-12" hidden$="{{_hideStep('envoi', currentStep)}}">
                    <div class="card">
                        <div class="row">
                            <div class="col-md-8 col-md-offset-2">
                                <div class="margin-top-bottom">
                                    <paper-checkbox checked="{{confirmationValidite}}">{{localize('header64')}}</paper-checkbox>
                                    <paper-checkbox checked="{{confirmationAutorite}}">{{localize('header65')}}</paper-checkbox>
                                </div>
                                <div class="text-center margin-top-bottom">
                                    <paper-button on-tap="_sendBiodatas" hidden$="{{chargement}}" disabled$="{{_validateBiodatas(champs, confirmationValidite, confirmationAutorite)}}">{{localize('header66')}}</paper-button>
                                    <paper-spinner hidden$="{{!chargement}}" active={{chargement}}></paper-spinner>
                                </div>
                            </div>
                        </div>
                    </div>  
                </div>
                <paper-fab hidden$="[[!_hideStep('accueil', currentStep)]]" class="see-previous" icon=":icons:chevron-left" on-tap="_showPrevious"></paper-fab>
                <paper-fab hidden$="[[!_hideStep('envoi', currentStep)]]" class="see-next" icon=":icons:chevron-right" on-tap="_showNext"></paper-fab>
            </div>
            <div class="col-md-4">
                 <conseils-biodatas current-step="{{currentStep}}" steps="{{steps}}" hovered-item-identifiant="{{hoveredItemIdentifiant}}" language="{{storedData.language}}"></conseils-biodatas>
            </div>
      </template>
      <confirmation-biodatas biodatas-ok="[[biodatasOk]]" biodatas-envoyees="[[biodatasEnvoyees]]" date-limite=[[dateLimite]]></confirmation-biodatas>
  </template>

  <script>
    Polymer({
      is: 'page-biodatas',
      behaviors: [
        Polymer.AppLocalizeBehavior
      ],
      properties: {
        champs: {
            type: Object,
            notify: true
        },
        language: {
          value: 'fr'
        },
        serverUrl: String,
        nationalites: Object,
        saisieNationalite: {
            type: Boolean,
            value: true,
            notify: true
        },
        fichiers: {
            type: Object,
            value: [],
            notify: true
        },
        currentStep: {
            type: String,
            value: "accueil"
        },
        steps: {
            type: Object,
            value: [
               "accueil",
               "identite",
               "fichiers",
               "vehicule",
               "envoi"
                ]
        },
        confirmationValidite: Boolean,
        confirmationAutorite: Boolean,
        biodatasOk: {
            type: Boolean,
            value: false
        },
        erreurs: {
            type: Object,
            value: []
        },
        dateFormat: Object,
        dateMax: {
            type: String,
            value: moment().format('YYYY-MM-DD')
        },
        dateLimite: {
            type: String,
            value: ''
        }
      },
      ready: function () {
        this.serverUrl = this.$.meta.byKey("server-url");
      },
      attributeChanged : function(name, type){
          if(this.getAttribute('class').includes('iron-selected')){
            this._generateRequests();
          }
      },
      attached: function() {
        this.loadResources(this.resolveUrl('../locales.json'));
      },
      _computeHeaders: function(storedData) {
        return {"Authorization": "JWT " + storedData.token };
      },
      _generateRequests: function() {
          this.language = this.storedData.language || 'fr';
          this.$.champsRequest.generateRequest();
          this.$.historiqueEnvoyeRequest.generateRequest();
          this.$.dateLimiteRequest.generateRequest();
      },
      _handleChampsResponse: function(res) {
          //console.log(this.champs);
          for (var i = 0; i < this.champs.length; i++) {
            this.champs[i].saisie = {};
          }
          
          console.log(this.champs);
          
          this._setSteps();
      },
      _setSteps: function() {
          
          var steps = [
                        "accueil"
                      ];
          
          for(var i=0; i < this.steps.length; i++) {
              for(var j=0; j < this.champs.length; j++) {
                if(this.steps[i] == this.champs[j].etape && (steps.indexOf(this.steps[i]) == -1)) {
                    steps.push(this.steps[i]);
                }
              }
          }
          
          steps.push("envoi");
          this.set('steps', steps);
      },
      _showNext: function(event) {
          if(this.steps[this.steps.indexOf(this.currentStep) + 1]) {
            this.currentStep = this.steps[this.steps.indexOf(this.currentStep) + 1];
          }
      },
      _showPrevious: function(event) {
          if(this.steps[this.steps.indexOf(this.currentStep) - 1]) {
            this.currentStep = this.steps[this.steps.indexOf(this.currentStep) - 1];
          }
      },
      _hideStep: function(step, currentStep) {
        return !(step == currentStep);
      },
      _computeHidden: function(item, type) {
          return (item.type == type && item.coche == true);
      },
      _isObligatoire: function(item) {
          return item.obligatoire
      },
      _isNationality: function(item) {
          
          var nationaliteDemandee = false;
          var selectedNationalite = "";
          
          for(var i=0; i < this.champs.length; i++) {
            if(this.champs[i].type == 'identite_nationalite') {
                nationaliteDemandee = true;
                selectedNationalite = this.champs[i].saisie.nationalite || "";
            }
          }
          
          if(nationaliteDemandee == true && selectedNationalite != "") {
            if(selectedNationalite.toLowerCase() == 'française' || selectedNationalite.toLowerCase() == 'francaise'
               || selectedNationalite.toLowerCase() == 'français' || selectedNationalite.toLowerCase() == 'francais') {
                if(item.nom == "Carte d'identité" || item.nom == "Passeport") {
                    return true;
                } else {
                    return false;
                }
            } else {         
                if(item.nom == "Carte de séjour" || item.nom == "Passeport") {
                    return true;
                } else {
                    return false;
                }   
            }
          } else if(selectedNationalite == "") {
              return false;
          } else {
              return true;
          }
      },
      _addFile: function(event) {
          var item = event.model.get('item');
          var fichier = Polymer.dom(this.root).querySelector('#fichier'+item.identifiant).files[0];
          if (this.fichiers.find(fichier => fichier.identifiantChamp === item.identifiant)) {
              console.log(this.fichiers.find(fichier => fichier.identifiantChamp === item.identifiant));
              
              for(var i=0 ; i < this.fichiers.length; i++) {
                    if(this.fichiers[i].identifiantChamp == item.identifiant) {
                        this.fichiers.splice(i, 1); 
                    }
              }
          }
          
          
          for(var i=0 ; i < this.champs.length; i++) {
              if(this.champs[i].identifiant == item.identifiant) {
                  this.champs[i].saisie.fichier = fichier.name;
              }
          }
          
          this.fichiers.push({ identifiantChamp: item.identifiant, fichier: fichier});
          this.notifyPath('champs', this.champs);
          let arr_clone = this.fichiers.slice(0);
          this.set('fichiers', arr_clone);
      },
      _getFileName: function(item, fichiers) {
          //var item = event.model.get('item');
          for(var i=0 ; i < this.fichiers.length; i++) {
                    if(this.fichiers[i].identifiantChamp == item.identifiant) {
                        return 'Fichier selectionné: ' + this.fichiers[i].fichier.name + ' - ' + this._bytesToKo(this.fichiers[i].fichier.size);
                        console.log(this.fichiers[i].fichier);
                    }
          }
//          
//          if(this.fichiers[0] != undefined && this.fichiers[0].identifiantChamp != undefined) {
//            return this.fichiers[0].identifiantChamp;
//          }
          //var fichier = Polymer.dom(this.root).querySelector('#fichier'+item.identifiant).files[0];
          //console.log(item);
          //return 'fichier.nom';
      },
      _validateBiodatas: function(champs, confirmationValidite, confirmationAutorite) {
          if(confirmationValidite == true && confirmationAutorite == true) {
              for(var i=0 ; i < champs.length; i++) {
                    if(champs[i].obligatoire == true) {
                        if(Object.keys(champs[i].saisie).length == 0) {
                            return true;
                        }
                    }
              }
              return false;
          } else {
              return true;
          }
      },
      _bytesToKo: function(a, b) {
          if(0==a)return"0 Bytes";
          var c=1e3,d=b||2,e=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"],f=Math.floor(Math.log(a)/Math.log(c));
          return parseFloat((a/Math.pow(c,f)).toFixed(d))+" "+e[f];
      },
      _sendBiodatas: function() {
          this.chargement = true;
          var formData = new FormData();
          
          /* Ajout des fichiers à la requette */
          
          for(var i=0 ; i < this.fichiers.length; i++) {
            formData.append("fichiers", this.fichiers[i].fichier);
          }
          /* Ajout des champs à la requette */
        
          formData.append("champs", JSON.stringify(this.champs));
          console.log(this.champs);
          this.$.biodatasRequest.body = formData;
          this.$.biodatasRequest.generateRequest();
      },
      _handleBiodatasResponse: function(event) {
          if(event.detail.response == true) {
             this.biodatasOk = true;
             this.chargement = false;
          } else {
             this.erreurs = event.detail.response;
             this.fire('iron-signal', {name: 'open-erreur-biodatas-modal', data: { erreurs: this.erreurs }});
             this.chargement = false;
          }
      },
      _handleHttpError: function(event) {
          if(event.detail.request.xhr.status == 401) {
            this.fire('iron-signal', {name: 'connexion-visiteur-denied', data: {}});
          }
      },
      _itemHovered: function(event) {
        this.hoveredItemIdentifiant = event.model.get('item').identifiant;   
      },
      _itemHovered: function(event) {
        this.hoveredItemIdentifiant = event.model.get('item').identifiant;   
      },
      _aucunItem: function(event) {
          this.hoveredItemIdentifiant = -1;
      },
      _afficherFormulaire: function(biodatasOk, biodatasEnvoyees, dateLimite) {
          if(dateLimite < moment().startOf('day').format('x')) {
             return false;
          } else {
              if(biodatasEnvoyees == false) {
                return biodatasOk == false;
              } else {
                return false;
              }   
          }
      },
      _saisieNationalite: function() {
         this.saisieNationalite = !this.saisieNationalite;
      }
    });
  </script>
</dom-module>
